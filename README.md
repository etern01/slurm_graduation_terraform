Ниже представлена документация для файла конфигурации GitLab CI/CD на основе предоставленного кода:

# Документация для GitLab CI/CD конфигурации с использованием Terraform

## Описание

Данная конфигурация определяет CI/CD пайплайн для автоматизации работы с Terraform инфраструктурой. Пайплайн состоит из нескольких этапов, таких как валидация, проверка безопасности, планирование, применение и удаление инфраструктуры. Каждый этап выполняется в контейнере Docker с необходимыми зависимостями.

## Основные характеристики

- Версия Terraform: 1.5.3 (используется образ hashicorp/terraform:1.5.3).
- В качестве образов для дополнительных инструментов используются bridgecrew/checkov:latest для проверки безопасности и wata727/tflint:latest для линтера Terraform кода.
- Для ускорения работы проекта используется кэширование Terraform, сохраняемое по хешу последнего коммита ($CI_COMMIT_SHA).

## Переменные окружения

- YC_SERVICE_ACCOUNT_KEY_FILE: Путь к файлу с ключами сервисного аккаунта Yandex.Cloud. Значение по умолчанию - /tmp/sa-key.json.

## Этапы

### Этап "validate"

- Валидирует синтаксис и структуру Terraform кода с помощью команды "terraform validate".

### Этап "checkov"

- Использует инструмент "checkov" для проверки Terraform кода на наличие ошибок и нарушений безопасности.
- Работает в контейнере bridgecrew/checkov:latest.
- Если проверка завершается с ошибкой, этап разрешено завершиться неудачно (allow_failure: true).

### Этап "tflint"

- Производит линтинг Terraform кода с использованием инструмента "tflint".
- Работает только с Terraform 0.12 кодом.
- Запускается в контейнере wata727/tflint:latest.
- Если линтинг завершается с ошибкой, этап разрешено завершиться неудачно (allow_failure: true).

### Этап "plan"

- Инициализирует Terraform, запуская команду "terraform init" с определенной конфигурацией.
- Выполняет планирование изменений инфраструктуры с помощью команды "terraform plan -out=planfile".
- Создает артефакт "planfile" с результатами планирования для последующего применения.
- Зависит от успешного выполнения этапа "validate".

### Этап "apply"

- Инициализирует Terraform, запуская команду "terraform init" с определенной конфигурацией.
- Применяет изменения инфраструктуры из файла "planfile" с помощью команды "terraform apply -input=false "planfile"".
- Этап выполняется вручную и доступен только для ветки "main".
- Зависит от успешного выполнения этапа "plan".

### Этап "destroy"

- Инициализирует Terraform, запуская команду "terraform init" с определенной конфигурацией.
- Удаляет всю инфраструктуру с помощью команды "terraform destroy --auto-approve".
- Этап выполняется вручную и доступен только для ветки "main".

## Использование

1. Убедитесь, что ваши Terraform конфигурационные файлы расположены в репозитории проекта.
2. Проверьте значения переменных окружения, особенно YC_SERVICE_ACCOUNT_KEY_FILE, чтобы они были настроены под ваш проект.
3. Коммитте и отправьте изменения в ваш репозиторий.
4. Пайплайн будет автоматически запущен при каждом коммите в ветку "main".
5. Для применения или удаления изменений инфраструктуры, выполните соответствующие этапы "apply" или "destroy" вручную через интерфейс GitLab CI/CD.

Это руководство предоставляет основную информацию об использовании и настройке CI/CD пайплайна для Terraform проекта с помощью GitLab CI/CD. Настройте параметры согласно вашим потребностям и условиям вашего проекта.